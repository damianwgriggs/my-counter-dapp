<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuji Counter DApp</title>
    <style>
        /* CSS for a clean, simple interface */
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 400px; margin: 40px auto; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        button { padding: 12px 25px; margin: 10px 5px; cursor: pointer; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; transition: background-color 0.3s, transform 0.1s; }
        button:active { transform: scale(0.98); }
        #connectWalletBtn { background-color: #007bff; color: white; }
        #incrementBtn { background-color: #28a745; color: white; font-size: 24px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; font-weight: 500; color: #555; min-height: 20px; }
        #countDisplay { font-size: 60px; font-weight: bold; margin: 20px 0; color: #DC3545; }
        .info { margin-top: 10px; font-size: 14px; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fuji Counter DApp</h1>

        <button id="connectWalletBtn">CONNECT WALLET</button>
        <p class="info" id="walletInfo">Wallet Status: Disconnected.</p>
        <hr>

        <h2>Current Count:</h2>
        <div id="countDisplay">...</div>
        
        <button id="incrementBtn" disabled>+ Increment</button>

        <p id="status">Loading initial count...</p>
        <p class="info">Network: Avalanche Fuji Testnet</p>
    </div>

    <script>
        // 1. --- CONTRACT CONFIGURATION (CONFIRMED CORRECT) ---
        const CONTRACT_ADDRESS = "0x689EB1ceFa6EdB474814f04A7B6357c8Ea0Dfbcc"; 
        
        // Confirmed Signatures:
        const GET_COUNT_SIG = '0xa87d942c'; 
        const INCREMENT_SIG = '0xd09de08a'; 

        const FUJI_CHAIN_ID_HEX = '0xa869'; // 43113 in hex
        const FUJI_RPC_URL = 'https://api.avax-test.network/ext/bc/C/rpc';
        
        // 2. --- STATE VARIABLES & DOM ELEMENTS ---
        let currentAccount = null;
        const countDisplay = document.getElementById("countDisplay");
        const statusDisplay = document.getElementById("status");
        const connectWalletBtn = document.getElementById("connectWalletBtn");
        const walletInfo = document.getElementById("walletInfo");
        const incrementBtn = document.getElementById("incrementBtn");
        
        // 3. --- CORE FUNCTIONS ---

        /**
         * Reads the current count from the contract using the Public RPC.
         */
        async function getCount() {
            statusDisplay.textContent = "Fetching count...";

            try {
                const response = await fetch(FUJI_RPC_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'eth_call',
                        params: [{ to: CONTRACT_ADDRESS, data: GET_COUNT_SIG }, 'latest']
                    })
                });
                
                const data = await response.json();

                if (data.error) throw new Error(data.error.message || "RPC call failed.");
                
                const count = BigInt(data.result);
                countDisplay.textContent = count.toString();
                
                // Only update status if the wallet is not already connected
                if (!currentAccount) {
                    statusDisplay.textContent = "Current count loaded. Connect wallet to increment.";
                }

            } catch (error) {
                console.error("RPC Error:", error);
                statusDisplay.textContent = 'Error: Failed to load count.';
                countDisplay.textContent = 'Error';
            }
        }

        /** Handles network checking and switching. */
        async function checkNetwork(chainId) {
            if (chainId !== FUJI_CHAIN_ID_HEX) {
                const fujiParams = {
                    chainId: FUJI_CHAIN_ID_HEX,
                    chainName: 'Avalanche Fuji C-Chain',
                    nativeCurrency: { name: 'AVAX', symbol: 'AVAX', decimals: 18 },
                    rpcUrls: [FUJI_RPC_URL],
                    blockExplorerUrls: ['https://testnet.snowtrace.io']
                };
                
                try {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: FUJI_CHAIN_ID_HEX }] });
                    // On successful switch, MetaMask usually refreshes/reconnects automatically
                    return false; 
                } catch (e) {
                    if (e.code === 4902) { 
                        await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [fujiParams] });
                        return false; 
                    }
                    throw e;
                }
            }
            return true;
        }

        /** Connects wallet and verifies correct network. (The "normal way") */
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                statusDisplay.textContent = 'Please install MetaMask to use this DApp.';
                return;
            }

            try {
                statusDisplay.textContent = "Connecting to wallet...";
                
                // 1. Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0];

                // 2. Check network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const isOnFuji = await checkNetwork(chainId);
                
                if (isOnFuji) {
                    // 3. Update UI
                    walletInfo.textContent = `Connected: ${currentAccount.substring(0, 6)}...${currentAccount.slice(-4)}`;
                    connectWalletBtn.textContent = 'Wallet Connected';
                    connectWalletBtn.disabled = true;
                    incrementBtn.disabled = false;
                    statusDisplay.textContent = 'Ready! Click Increment.';
                    await getCount(); // Final refresh
                } else {
                    // This happens if checkNetwork returns false (user needs to switch/add)
                    statusDisplay.textContent = 'Please approve the network change in your wallet and click Connect again.';
                }

            } catch (error) {
                console.error("Connection failed:", error);
                statusDisplay.textContent = 'Connection failed. Check console.';
                connectWalletBtn.disabled = false;
                incrementBtn.disabled = true;
            }
        }

        /** Sends the transaction to increment the counter. */
        async function increment() {
            if (!currentAccount) {
                statusDisplay.textContent = "Please connect your wallet first.";
                return;
            }
            
            incrementBtn.disabled = true; 
            statusDisplay.textContent = 'Sending transaction... Awaiting wallet approval.';

            try {
                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{ from: currentAccount, to: CONTRACT_ADDRESS, data: INCREMENT_SIG }]
                });

                statusDisplay.textContent = `Transaction sent! Hash: ${txHash.substring(0, 10)}... Please wait a moment.`;
                
                await new Promise(resolve => setTimeout(resolve, 5000));
                
                statusDisplay.textContent = 'Transaction sent. Checking new count...';
                await getCount();

            } catch (error) {
                console.error("Transaction failed:", error);
                statusDisplay.textContent = (error.code === 4001) ? 'Transaction rejected by user.' : 'Transaction failed. See console.';
            } finally {
                incrementBtn.disabled = false;
            }
        }

        // 4. --- EVENT LISTENERS and Initial Load ---
        connectWalletBtn.addEventListener("click", connectWallet);
        incrementBtn.addEventListener("click", increment);

        // Initial load of the count using Public RPC
        getCount(); 
    </script>
</body>
</html>
